<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Heldenbrief - Edition 2025</title>

<style>
:root {
  --bg-dark: #050306;
  --panel-bg: linear-gradient(135deg, #1a121a 0%, #0a050a 100%);
  --stone-bg: radial-gradient(circle, #3d3d3d 0%, #1a1a1a 100%);
  --gold: #d4af37;
  --gold-bright: #f8e7b0;
  --gold-shadow: rgba(212, 175, 55, 0.5);
  --text: #eaddca;
  --muted: #a69586;
  --danger: #ff4b5c;
  --header-gradient: linear-gradient(to bottom, rgba(60,10,10,0.9), rgba(30,5,10,1));
  --font-header: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
  --font-body: 'Georgia', serif;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: var(--bg-dark);
  color: var(--text);
  font-family: var(--font-body);
  min-height: 100vh;
}

#app-shell {
  width: 950px;
  margin: 20px auto;
  background: var(--panel-bg);
  border: 2px solid var(--gold);
  position: relative;
  border-radius: 8px;
  box-shadow: 0 10px 50px #000;
  overflow: hidden;
}

/* HEADER */

header {
  padding: 20px;
  background: var(--header-gradient);
  border-bottom: 2px solid var(--gold);
  text-align: center;
  position: relative;
}

header h1 {
  margin: 0;
  font-family: var(--font-header);
  color: var(--gold-bright);
  text-transform: uppercase;
  letter-spacing: 4px;
}

/* STEPS / PANELS */

.step-content {
  display: none;
  padding: 20px;
}

.step-content.active {
  display: block;
}

.panel {
  border: 1px solid var(--gold);
  margin-bottom: 20px;
  border-radius: 5px;
  background: rgba(0,0,0,0.4);
  overflow: hidden;
}

.panel-header {
  background: var(--header-gradient);
  padding: 8px 15px;
  border-bottom: 1px solid var(--gold);
  color: var(--gold-bright);
  font-family: var(--font-header);
  display: flex;
  justify-content: space-between;
  font-size: 14px;
}

/* GRIDS */

.identity-grid {
  display: grid;
  grid-template-columns: 180px 1fr 240px;
  gap: 15px;
  padding: 15px;
}

.attr-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px 30px;
  padding: 15px;
}

.origin-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 2px;
  background: var(--gold);
  border: 1px solid var(--gold);
  height: 300px;
}

.origin-col {
  background: #0a050a;
  overflow-y: auto;
  padding: 10px;
  scrollbar-width: thin;
  scrollbar-color: var(--gold) #000;
}

.origin-col h4 {
  color: var(--gold);
  text-align: center;
  border-bottom: 1px solid var(--gold-shadow);
  margin-top: 0;
  font-size: 14px;
}

/* BUTTONS */

.btn-main {
  padding: 10px 20px;
  border: 2px solid var(--gold);
  background: #2a1a0a;
  color: var(--gold);
  cursor: pointer;
  font-weight: bold;
  font-family: var(--font-header);
  text-transform: uppercase;
  border-radius: 20px;
  font-size: 12px;
}

.btn-next {
  background: linear-gradient(to bottom, #8a1515, #500505);
  color: white;
}

/* kleine Up-/Down-Buttons für Attribute */

.btn-step {
  width: 22px;
  height: 22px;
  background: #1a121a;
  border: 1px solid var(--gold);
  color: var(--gold-bright);
  cursor: pointer;
  font-size: 11px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 3px;
}

.btn-plus {
  background: #2a1a0a;
}

.btn-step:disabled,
.btn-plus:disabled {
  opacity: 0.3;
  cursor: default;
}

.btn-upgrade {
  width: 22px;
  height: 22px;
  background: #1a121a;
  border: 1px solid var(--gold);
  color: var(--gold);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
}

.btn-upgrade:hover {
  box-shadow: 0 0 6px var(--gold-shadow);
}

/* EFFECTS */

.glow {
  box-shadow: 0 0 10px var(--gold);
  border-color: var(--gold-bright);
  color: var(--gold-bright);
}

/* ATTR ROWS */

.attr-row {
  display: grid;
  grid-template-columns: 1fr auto 40px auto;
  gap: 10px;
  align-items: center;
  padding: 4px;
  border-bottom: 1px solid rgba(212,175,55,0.1);
}

.val-box {
  background: #000;
  border: 1px solid var(--gold);
  text-align: center;
  color: var(--gold-bright);
  border-radius: 3px;
  font-weight: bold;
}

/* LISTEN / TAGS */

.check-item {
  display: block;
  padding: 5px;
  cursor: pointer;
  border-bottom: 1px solid #222;
  font-size: 12px;
}

.check-item:hover {
  background: rgba(212,175,55,0.1);
}

.trait-tag {
  display: inline-block;
  background: rgba(212,175,55,0.1);
  border: 1px solid var(--gold-shadow);
  padding: 2px 8px;
  margin: 2px;
  border-radius: 10px;
  font-size: 11px;
}

/* FINAL SUMMARY */

.summary-panel-final {
  background: var(--stone-bg);
  padding: 30px;
  border-radius: 4px;
  box-shadow: inset 0 0 50px #000;
  border: 2px solid #333;
}

.ornamental-frame {
  border: 1px solid #444;
  padding: 20px;
  position: relative;
}

.ornamental-frame::before {
  content: "❦";
  position: absolute;
  top: -10px;
  left: -10px;
  color: var(--gold);
  font-size: 20px;
}

/* TIMELINE */

#timeline {
  position: absolute;
  right: 0;
  top: 100px;
  width: 100px;
  background: rgba(0,0,0,0.85);
  border-left: 1px solid var(--gold);
  padding: 10px;
  height: 500px;
  display: none;
  flex-direction: column;
  gap: 5px;
  overflow-y: auto;
  z-index: 10;
  border-radius: 8px 0 0 8px;
}

.day-check {
  font-size: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid #333;
  padding: 2px 0;
}

/* PORTRAIT */

.portrait-frame {
  width: 160px;
  height: 210px;
  border: 2px solid var(--gold);
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  border-radius: 8px;
}

.portrait-frame img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* STATUS TOP GRID */

.status-top-grid {
  display: grid;
  grid-template-columns: 1fr 180px 240px;
  gap: 2px;
  background: var(--gold);
  border: 1px solid var(--gold);
  margin-bottom: 20px;
}

.status-cell {
  background: #0a050a;
  padding: 15px;
  font-size: 12px;
}

/* SKILLS / INVENTAR */

.skill-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 3px 6px;
  background: rgba(0,0,0,0.3);
  margin-bottom: 2px;
  border-radius: 4px;
  font-size: 11px;
}

.inventar-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 8px;
  padding: 15px;
}

.inv-slot {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px;
  border: 1px solid #444;
  background: rgba(0,0,0,0.4);
  font-size: 10px;
}

/* MODALS */

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(4px);
}

.modal-box {
  background: var(--panel-bg);
  border: 2px solid var(--gold);
  padding: 30px;
  width: 400px;
  text-align: center;
  border-radius: 10px;
}

/* FORM ELEMENTE */

input[type="text"],
input[type="number"] {
  background: #000;
  border: 1px solid #444;
  color: var(--gold-bright);
  padding: 5px;
  border-radius: 4px;
  width: 100%;
}

.rule-hint-red {
  color: var(--danger);
  font-size: 11px;
  text-align: center;
  font-weight: bold;
  margin-top: 10px;
  font-style: italic;
}
</style>
</head>

<body>
<div id="app-shell">

  <div id="timeline"></div>

  <header>
    <h1 id="main-title">Heldenbrief</h1>
    <div id="header-sub-data" style="color: var(--gold); font-size: 13px; margin-top: 5px;"></div>
  </header>

  <!-- ================= STEP 1 ================= -->

  <div id="step-1" class="step-content active">

    <div class="panel">
      <div class="identity-grid">

        <div class="portrait-box">
          <div class="portrait-frame">
            <img id="preview" src="" style="display:none;">
            <div id="placeholder" style="color:#333">Portrait</div>
          </div>
          <input type="file" id="upload" style="font-size: 10px; margin-top: 5px; width: 100%;">
        </div>

        <div>
          <input type="text" id="in-name" placeholder="Name des Helden" style="font-size: 18px; margin-bottom: 10px;">
          <input type="text" id="in-titel" placeholder="Zusatz / Titel">

          <div style="margin-top: 15px; font-size: 13px; border: 1px solid var(--gold-shadow); padding: 10px; background: rgba(0,0,0,0.2);">
            <div><b>Rasse:</b> <span id="s-race">-</span></div>
            <div><b>Untergruppe:</b> <span id="s-sub">-</span></div>
            <div><b>Profession:</b> <span id="s-prof">-</span></div>
            <div style="color: var(--gold-bright); margin-top: 8px;">
              <b>Spezialfähigkeit:</b> <br>
              <span id="s-spec" style="font-style: italic;">Wähle Volk & Beruf...</span>
            </div>
          </div>
        </div>

        <div class="radar-box" style="background:rgba(0,0,0,0.4); border:1px solid var(--gold); padding:5px;">
          <canvas id="radarCanvas" width="220" height="220"></canvas>
        </div>

      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div>Basisattribute</div>
        <small>Maximalstufe je Basisattribut beträgt 10.</small>
      </div>
      <div id="attr-grid-s1" class="attr-grid"></div>
      <div style="padding: 15px; text-align: center; background: rgba(0,0,0,0.2);">
        <button class="btn-main" id="roll-btn">Punkte auswürfeln</button>
        <span style="margin-left: 20px;">Punkte: <b id="p-left">0</b></span>
      </div>
    </div>

    <div class="panel">
      <div class="origin-grid">
        <div class="origin-col" id="race-list"><h4>Rassen</h4></div>
        <div class="origin-col" id="sub-list"><h4>Untergruppen</h4></div>
        <div class="origin-col" id="prof-list"><h4>Professionen</h4></div>
      </div>
    </div>

    <div class="footer-bar" style="padding:15px; display:flex; justify-content:space-between;">
      <button class="btn-main" onclick="saveCharacterLocal()">Lokal Speichern</button>
      <button class="btn-main btn-next" onclick="toStep2()">Weiter zu Seite 2</button>
    </div>

  </div>

  <!-- ================= STEP 2 ================= -->

  <div id="step-2" class="step-content">

    <div class="panel">
      <div class="panel-header">Körperliche Merkmale & Identität</div>
      <div id="id-grid-s2" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; font-size: 12px;"></div>
    </div>

    <div class="panel">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; background: var(--gold);">
        <div class="origin-col" style="height: 300px;">
          <h4 style="position: sticky; top: 0; background: #0a050a; z-index: 5;">Vorteile (+1 SP)</h4>
          <div id="adv-list"></div>
        </div>
        <div class="origin-col" style="height: 300px;">
          <h4 style="position: sticky; top: 0; background: #0a050a; z-index: 5;">Nachteile (+1 SP)</h4>
          <div id="dis-list"></div>
        </div>
      </div>
      <div class="rule-hint-red">
        Bedingung: Mindestens 2 Vorteile und 3 Nachteile Pflicht. Nachteile müssen Vorteile immer um +1 übersteigen!
      </div>
    </div>

    <div class="summary-panel-final">
      <div class="ornamental-frame">
        <h3 style="font-family:var(--font-header); color:var(--gold); text-transform:uppercase; letter-spacing:4px; margin-bottom:15px; border-bottom:1px solid #444;">Helden-Chronik</h3>
        <div style="display: grid; grid-template-columns: 1fr 240px; gap: 20px;">
          <div id="chronik-text-block" style="font-size: 13px; line-height: 1.5;"></div>
          <div style="text-align:center;">
            <canvas id="chronikRadar" width="220" height="220" style="transform: scale(0.8);"></canvas>
            <div id="chronik-traits-cloud" style="margin-top: 5px;"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="footer-bar" style="padding:15px; display:flex; justify-content:space-between; margin-top:20px;">
      <button class="btn-main" onclick="toStep1()">Zurück</button>
      <button class="btn-main btn-next" id="btn-finish-check" onclick="toStep3()" disabled>Erstellung Abschließen</button>
    </div>

  </div>

  <!-- ================= STEP 3 ================= -->

  <div id="step-3" class="step-content">

    <div class="status-top-grid">
      <div class="status-cell" id="stat-merkmale-final"></div>
      <div class="status-cell" style="display:flex; justify-content:center;">
        <div class="portrait-frame"><img id="final-portrait"></div>
      </div>
      <div class="status-cell" style="background:rgba(0,0,0,0.6)">
        <canvas id="finalRadar" width="220" height="220"></canvas>
      </div>
    </div>

    <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
      <div class="panel">
        <div class="panel-header">Basis (50 SP)</div>
        <div id="skills-base" class="origin-col" style="height:220px;"></div>
      </div>
      <div class="panel">
        <div class="panel-header">Rasse (300 SP)</div>
        <div id="skills-race" class="origin-col" style="height:220px;"></div>
      </div>
      <div class="panel">
        <div class="panel-header">Profession (500 SP)</div>
        <div id="skills-prof" class="origin-col" style="height:220px;"></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">Aktive Attribute (1 Pkt / Tag)</div>
      <div id="active-attr-grid" class="attr-grid"></div>
    </div>

    <div class="panel" style="display:grid; grid-template-columns: repeat(5, 1fr); padding: 15px; text-align:center; background:var(--header-gradient); border:1px solid var(--gold);">
      <div id="calc-le"><b>LEBEN</b><br><span>0</span></div>
      <div id="calc-en"><b>AUSDAUER</b><br><span>0</span></div>
      <div id="calc-rs"><b>RÜSTUNG</b><br><span>0</span></div>
      <div id="calc-gg"><b>GEIST</b><br><span>0</span></div>
      <div id="calc-tc"><b>TREFFER%</b><br><span>0</span></div>
    </div>

    <div class="panel">
      <div class="panel-header">Inventar & Handel</div>
      <div class="inventar-grid" id="inv-grid"></div>
    </div>

    <div class="footer-bar" style="padding:15px; display:flex; justify-content:space-between; background: rgba(0,0,0,0.8);">
      <div style="font-size: 14px; color:var(--gold-bright);">
        Währung: <span id="currency-display" style="color:var(--gold);">0 G 0 S 0 K</span>
      </div>
      <div style="font-size: 14px; color:var(--gold-bright);">
        SP: <span id="sp-display" style="color:var(--gold);">5000</span>
      </div>
      <button class="btn-main btn-next" id="btn-dayend">Tag beenden</button>
    </div>

  </div>

  <!-- ============ MODAL: VERKAUF / HANDEL ============ -->

  <div id="sell-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="margin-top:0; font-family:var(--font-header); color:var(--gold-bright);">Verkauf / Handel</h3>
      <p style="font-size:13px; color:var(--muted); margin-bottom:15px;">
        Trage den Erlös dieses Verkaufs ein:
      </p>
      <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-bottom:15px;">
        <div>
          <span style="font-size:12px;">Gold</span>
          <input type="number" id="v-gold" min="0" value="0">
        </div>
        <div>
          <span style="font-size:12px;">Silber</span>
          <input type="number" id="v-silber" min="0" value="0">
        </div>
        <div>
          <span style="font-size:12px;">Kupfer</span>
          <input type="number" id="v-kupfer" min="0" value="0">
        </div>
      </div>
      <div style="display:flex; justify-content:center; gap:10px; margin-top:10px;">
        <button class="btn-main" onclick="document.getElementById('sell-modal').style.display='none'">Abbrechen</button>
        <button class="btn-main btn-next" onclick="confirmSell()">Bestätigen</button>
      </div>
    </div>
  </div>

  <!-- ============ MODAL: TAG BEENDET / DANKESBILDSCHIRM ============ -->

  <div id="thanks-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 style="margin-top:0; font-family:var(--font-header); color:var(--gold-bright);">Tag abgeschlossen</h3>
      <p id="thanks-text" style="font-size:13px; color:var(--muted); margin-bottom:15px;">
        Tag 1 abgeschlossen. Du erhältst 1000 SP und 1 Attributpunkt.
      </p>
      <button class="btn-main btn-next" onclick="closeThanks()">Weiter</button>
    </div>
  </div>

</div> <!-- /app-shell -->
<script>


/* ============================================================
   UNDRA ENGINE v1.1 — BLOCK 2/10
   CORE-DATEN + INITIALISIERUNG + BASIS-FUNKTIONEN
   ============================================================ */

/* -----------------------------
   ATTRIBUTE & SHORTCODES
----------------------------- */

const attributes = [
  "Mut","Intelligenz","Fingerfertigkeit","Gewandtheit","Körperkraft",
  "Körperbewusstsein","Konstitution","Charisma","Sozialstatus",
  "Geistiger Zustand","Intuition","Angriff","Verteidigung",
  "Abwehrschlag","Fernkampf","Trefferchance","Technik"
];

/* -----------------------------
   RASSEN / SUBRASSEN / PROFESSIONEN — v1.1
----------------------------- */

const originData = {

  "Mensch": {
    subs: ["Mittelländer","Tulamiden","Thorwaler","Nivesen","Norbarden"],
    profs: ["Ritter","Dieb","Händler","Feuermagier","Druide"]
  },

  "Zwerg": {
    subs: ["Ambosszwerge","Erzzwerge","Hügelzwerge","Tiefenzwerge"],
    profs: ["Waffenschmied","Bergmann","Krieger"]
  },

  "Halbling": {
    subs: ["Ackerbürger","Landadel","Flussstrolche"],
    profs: ["Kundschafter","Dieb","Barde"]
  },

  "Drachengeborene": {
    subs: ["Feuerblut","Eisatem","Giftzahn","Sturmschwingen"],
    profs: ["Krieger","Schamane","Feuermagier"]
  },

  "Echsenmenschen": {
    subs: ["Achaz","Maru"],
    profs: ["Schamane","Kundschafter"]
  },

  "Schlangenmenschen": {
    subs: ["Shingwa","Ssad'Navv","Zsahh-Kultisten"],
    profs: ["Assassine","Hexer"]
  },

  "Ork": {
    subs: ["Schwarzpelze","Zholochai","Mhurakh","Korogai"],
    profs: ["Krieger","Schamane","Berserker"]
  },

  "Goblin": {
    subs: ["Festumer Goblins","Waldgoblins","Höhlengoblins"],
    profs: ["Dieb","Schamane","Jäger"]
  },

  "Gnom": {
    subs: ["Tiefengnome","Tüftler","Waldgnome"],
    profs: ["Erfinder","Alchemist","Barde"]
  },

  "Tabaxi": {
    subs: ["Dschungelpfoten","Wüstenläufer","Schneeleoparden","Grenzländer"],
    profs: ["Jäger","Kundschafter","Mönch"]
  },

  "Halbork": {
    subs: ["Stadt-Halborks","Verstoßene"],
    profs: ["Krieger","Söldner"]
  },

  "Troll": {
    subs: ["Höhlentrolle","Bergtrolle","Waldtrolle"],
    profs: ["Berserker","Schamane"]
  }

};

/* -----------------------------
   SPEZIALFÄHIGKEITEN — RASSE
----------------------------- */

const raceSpecials = {
  "Mensch": ["Anpassungsfähig","Zäher Wille","Diplomatisches Geschick","Improvisationstalent","Überlebensinstinkt"],
  "Zwerg": ["Steinherz","Dunkelsicht","Eisenhaut","Bergwissen","Runenresonanz"],
  "Halbling": ["Glückskind","Leisetreter","Unauffällig","Flink wie ein Wiesel","Heimvorteil"],
  "Drachengeborene": ["Drachenodem","Schuppenhaut","Elementarresistenz","Drakonische Präsenz","Blut des Ahnen"],
  "Echsenmenschen": ["Kalte Instinkte","Regeneration","Amphibisch","Schuppenpanzer","Ritualblut"],
  "Schlangenmenschen": ["Giftzahn","Hypnoseblick","Schlangengang","Kaltherzig","Schleier der Täuschung"],
  "Ork": ["Berserkerwut","Blutrausch","Zäh wie Leder","Kriegsgebrüll","Nachtjäger"],
  "Goblin": ["Schattenkriecher","Giftmischer","Flinkfinger","Tunnelblick","Rudeltaktik"],
  "Gnom": ["Tüftlergeist","Illusionssinn","Mechanikus","Funkenmagie","Scharfsinn"],
  "Tabaxi": ["Katzenreflexe","Nachtsicht","Sprungkraft","Jägerinstinkt","Lautloser Schritt"],
  "Halbork": ["Halbwild","Zornreserve","Einschüchternde Präsenz","Knochenpanzer","Zäher Körper"],
  "Troll": ["Regeneration","Felsenschlag","Trollhaut","Urkraft","Steinblut"]
};

/* -----------------------------
   SPEZIALFÄHIGKEITEN — SUBRASSEN
----------------------------- */

const subSpecials = {

  "Mittelländer": ["Pflichtbewusst","Standhaft","Taktisches Denken"],
  "Tulamiden": ["Wüstenläufer","Feilscher","Hitzeresistenz"],
  "Thorwaler": ["Berserkerblut","Seefahrer","Sturmlauf"],
  "Nivesen": ["Tierverbunden","Spurenleser","Eisresistenz"],
  "Norbarden": ["Händlerblut","Glücksrad","Zähigkeit"],

  "Ambosszwerge": ["Schmiedefeuer","Runenblick","Erzhaut"],
  "Erzzwerge": ["Tiefensicht","Steinwissen","Axtmeister"],
  "Hügelzwerge": ["Naturverbunden","Felsensinn","Zäher Körper"],
  "Tiefenzwerge": ["Dunkelpfad","Höhleninstinkt","Steinschild"],

  "Ackerbürger": ["Bodenverbunden","Erntesegen","Zäher Wille"],
  "Landadel": ["Feinsinn","Etikette","Glücksgriff"],
  "Flussstrolche": ["Flussschritt","Schleicher","Schnellfinger"],

  "Feuerblut": ["Feuerodem","Hitzeschild","Glutkern"],
  "Eisatem": ["Frosthauch","Kälteschild","Eisader"],
  "Giftzahn": ["Toxischer Biss","Giftresistenz","Schlangensinn"],
  "Sturmschwingen": ["Windstoß","Sturmresistenz","Donnerblick"],

  "Achaz": ["Ritualblut","Schuppenpanzer","Kalte Logik"],
  "Maru": ["Sumpftritt","Tarnhaut","Amphibisch"],

  "Shingwa": ["Schleierblick","Giftader","Hypnose"],
  "Ssad'Navv": ["Schattenhaut","Blutmagie","Schlangentanz"],
  "Zsahh-Kultisten": ["Kultwissen","Ritualklinge","Schleier der Täuschung"],

  "Schwarzpelze": ["Kriegsgebrüll","Blutdurst","Nachtjäger"],
  "Zholochai": ["Wüstenkrieger","Sandhaut","Hitzeresistenz"],
  "Mhurakh": ["Knochenpanzer","Urkraft","Berserkerwut"],
  "Korogai": ["Reiterkrieger","Jagdinstinkt","Rudeltaktik"],

  "Festumer Goblins": ["Stadtgassen-Instinkt","Flinkfinger","Schattenlauf"],
  "Waldgoblins": ["Tarnhaut","Waldwissen","Rudelruf"],
  "Höhlengoblins": ["Dunkelsicht","Tunnelkriecher","Giftmischer"],

  "Tiefengnome": ["Funkenmagie","Mechanikus","Illusionsblick"],
  "Tüftler": ["Erfindergeist","Schraubensinn","Schnellreparatur"],
  "Waldgnome": ["Naturflüstern","Tarnhaut","Tierfreund"],

  "Dschungelpfoten": ["Kletterkralle","Dschungelsinn","Sprungkraft"],
  "Wüstenläufer": ["Hitzeresistenz","Sandtritt","Jägerblick"],
  "Schneeleoparden": ["Frostfell","Eisresistenz","Lautloser Schritt"],
  "Grenzländer": ["Spurenleser","Überlebensinstinkt","Reflexschub"],

  "Stadt-Halborks": ["Einschüchternde Präsenz","Straßenkampf","Zähigkeit"],
  "Verstoßene": ["Urwut","Überlebensdrang","Knochenpanzer"],

  "Höhlentrolle": ["Dunkelwucht","Regeneration","Felsenschlag"],
  "Bergtrolle": ["Steinblut","Urkraft","Bergschritt"],
  "Waldtrolle": ["Tarnhaut","Naturwucht","Trollhaut"]
};

/* -----------------------------
   PROFESSION = ATTRIBUTSBONUS
----------------------------- */

function getProfessionAttributeOptions() {
    const opts = [];
    const used = new Set();

    while (opts.length < 3) {
        const idx = Math.floor(Math.random() * attributes.length);
        const attr = attributes[idx];
        if (!used.has(attr)) {
            used.add(attr);
            opts.push(`${attr} +1`);
        }
    }
    return opts;
}

/* -----------------------------
   CHARAKTERDATENSTRUKTUR
----------------------------- */

let char = {
  name: "",
  titel: "",
  attrs: {},
  pool: 0,
  used: 0,

  race: "",
  sub: "",
  prof: "",
  special: "",

  identity: {},
  adv: [],
  dis: [],

  sp: 5000,
  day: 1,
  gold: 0,
  silber: 0,
  kupfer: 0,

  skills: { base: {}, race: {}, prof: {} },

  dailyPoints: 0,
  dayEnded: false
};

/* ============================================================
   INITIALISIERUNG
============================================================ */

function init() {

  /* --- Attribute initialisieren --- */
  const grid1 = document.getElementById('attr-grid-s1');

  attributes.forEach(a => {
    char.attrs[a] = 0;

    grid1.innerHTML += `
      <div class="attr-row" id="row-${a}">
        <span style="font-size:12px;">${a}</span>
        <button class="btn-step" onclick="modAttr('${a}',-1)">▼</button>
        <div class="val-box" id="v-${a}">0</div>
        <button class="btn-step btn-plus" id="plus-${a}" onclick="modAttr('${a}',1)">▲</button>
      </div>`;
  });

  /* --- Rassenliste füllen --- */
  const rList = document.getElementById('race-list');
  Object.keys(originData).forEach(r => {
    rList.innerHTML += `<div class="check-item" onclick="selectRace('${r}')">${r}</div>`;
  });

  /* --- Identitätsfelder füllen --- */
  const idGrid = document.getElementById('id-grid-s2');
  idFields.forEach(f => {
    idGrid.innerHTML += `
      <div>
        <span style="color:var(--muted)">${f.l}</span>
        <input type="text" oninput="char.identity['${f.id}']=this.value">
      </div>`;
  });

  /* --- Portrait Loader --- */
  document.getElementById("upload").addEventListener("change", loadPortrait);

  updateUI();
}

/* ============================================================
   PORTRAIT
============================================================ */

function loadPortrait(e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(ev) {
        document.getElementById("preview").src = ev.target.result;
        document.getElementById("preview").style.display = "block";
        document.getElementById("placeholder").style.display = "none";
    };
    reader.readAsDataURL(file);
}

/* ============================================================
   ATTRIBUTE MODIFIZIEREN
============================================================ */

function modAttr(a, v) {

  if (v > 0) {
    if (char.pool - char.used <= 0) return;
    if (char.attrs[a] >= 10) return;
  }

  if (v < 0 && char.attrs[a] <= 0) return;

  char.attrs[a] += v;
  char.used += v;

  updateUI();
}

/* ============================================================
   RASSE / SUB / PROFESSION
============================================================ */

function selectRace(r) {
  char.race = r;
  char.sub = "";
  char.prof = "";
  char.special = "";

  const sList = document.getElementById('sub-list');
  sList.innerHTML = "<h4>Untergruppen</h4>";

  originData[r].subs.forEach(s => {
    sList.innerHTML += `<div class="check-item" onclick="selectSub('${s}')">${s}</div>`;
  });

  updateUI();
}

function selectSub(s) {
  char.sub = s;
  char.prof = "";
  char.special = "";

  const pList = document.getElementById('prof-list');
  pList.innerHTML = "<h4>Professionen</h4>";

  originData[char.race].profs.forEach(p => {
    pList.innerHTML += `<div class="check-item" onclick="selectProf('${p}')">${p}</div>`;
  });

  updateUI();
}

function selectProf(p) {
  char.prof = p;
  char.special = "";

  openSpecialModal();
  updateUI();
}

/* ============================================================
   SPEZIALFÄHIGKEITEN POPUP
============================================================ */

function getSpecialOptions(race, sub, prof) {
    const raceList = raceSpecials[race] || [];
    const subList = subSpecials[sub] || [];
    const profList = getProfessionAttributeOptions();

    const pool = [...raceList, ...subList, ...profList];

    const result = [];
    const used = new Set();

    while (result.length < 3 && pool.length > 0) {
        const pick = pool[Math.floor(Math.random() * pool.length)];
        if (!used.has(pick)) {
            used.add(pick);
            result.push(pick);
        }
    }
    return result;
}

function openSpecialModal() {
    const opts = getSpecialOptions(char.race, char.sub, char.prof);
    const box = document.getElementById("spec-options");
    box.innerHTML = "";

    opts.forEach(o => {
        box.innerHTML += `
            <button class="btn-main" onclick="selectSpecial('${o}')">${o}</button>
        `;
    });

    document.getElementById("spec-modal").style.display = "flex";
}

function selectSpecial(s) {
    char.special = s;
    document.getElementById("spec-modal").style.display = "none";
    updateUI();
}

/* ============================================================
   UI UPDATE
============================================================ */

function updateUI() {

  /* --- Name / Titel --- */
  char.name = document.getElementById("in-name").value;
  char.titel = document.getElementById("in-titel").value;

  /* --- Anzeige aktualisieren --- */
  document.getElementById("s-race").textContent = char.race || "-";
  document.getElementById("s-sub").textContent = char.sub || "-";
  document.getElementById("s-prof").textContent = char.prof || "-";
  document.getElementById("s-spec").textContent = char.special || "Wähle Volk & Beruf...";

  /* --- Attribute aktualisieren --- */
  attributes.forEach(a => {
    document.getElementById("v-" + a).textContent = char.attrs[a];
  });

  /* --- Radar zeichnen --- */
  drawRadar();

  /* --- Step 1 Freischaltung --- */
  const nextBtn = document.querySelector("#step-1 .btn-next");
  if (char.race && char.sub && char.prof && char.special) {
      nextBtn.disabled = false;
  } else {
      nextBtn.disabled = true;
  }
}

/* ============================================================
   RADAR
============================================================ */

function drawRadar() {
    const canvas = document.getElementById("radarCanvas");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const values = attributes.map(a => char.attrs[a] || 0);
    const max = 10;
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const r = 90;

    ctx.strokeStyle = "rgba(212,175,55,0.6)";
    ctx.lineWidth = 2;
    ctx.beginPath();

    values.forEach((v, i) => {
        const angle = (Math.PI * 2 / values.length) * i - Math.PI / 2;
        const dist = (v / max) * r;

        const x = cx + Math.cos(angle) * dist;
        const y = cy + Math.sin(angle) * dist;

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });

    ctx.closePath();
    ctx.stroke();

    /* Punkte zeichnen */
    ctx.fillStyle = "var(--gold)";
    values.forEach((v, i) => {
        const angle = (Math.PI * 2 / values.length) * i - Math.PI / 2;
        const dist = (v / max) * r;

        const x = cx + Math.cos(angle) * dist;
        const y = cy + Math.sin(angle) * dist;

        ctx.beginPath();
        ctx.arc(x, y, 3, 0, Math.PI * 2);
        ctx.fill();
    });
}
/* ============================================================
   RADAR-DIAGRAMM
============================================================ */

function drawRadar(id) {

  const canvas = document.getElementById(id);
  const ctx = canvas.getContext("2d");

  const cx = 110, cy = 110, r = 70;
  ctx.clearRect(0,0,220,220);

  const step = (Math.PI*2)/attributes.length;

  /* Linien */
  ctx.strokeStyle = "rgba(212,175,55,0.25)";

  attributes.forEach((a, i) => {
    const angle = step*i - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx + Math.cos(angle)*r, cy + Math.sin(angle)*r);
    ctx.stroke();

    ctx.fillStyle = "#d4af37";
    ctx.font = "8px serif";
    ctx.fillText(attrShort[i], cx + Math.cos(angle)*(r+12) - 5, cy + Math.sin(angle)*(r+12) + 3);
  });

  /* Wertefläche */
  ctx.beginPath();
  ctx.strokeStyle = "#f8e7b0";
  ctx.lineWidth = 2;
  ctx.fillStyle = "rgba(212,175,55,0.35)";

  attributes.forEach((a, i) => {
    const val = (char.attrs[a] / 10) * r;
    const angle = step*i - Math.PI/2;
    const x = cx + Math.cos(angle)*val;
    const y = cy + Math.sin(angle)*val;

    if (i === 0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });

  ctx.closePath();
  ctx.fill();
  ctx.stroke();
}

/* ============================================================
   VORTEILE / NACHTEILE
============================================================ */

/* ============================================================
   UNDRA ENGINE v1.1 — BLOCK 3/10
   VORTEILE / NACHTEILE + BEDINGUNGEN + STEP-2 LOGIK
   ============================================================ */

/* -----------------------------
   VORTEILE / NACHTEILE RENDERN
----------------------------- */

function renderTraits() {
    const advBox = document.getElementById("adv-list");
    const disBox = document.getElementById("dis-list");

    advBox.innerHTML = "";
    disBox.innerHTML = "";

    advPool.forEach(a => {
        advBox.innerHTML += `
            <div class="check-item" onclick="toggleAdv('${a}')">
                ${a}
            </div>`;
    });

    disPool.forEach(d => {
        disBox.innerHTML += `
            <div class="check-item" onclick="toggleDis('${d}')">
                ${d}
            </div>`;
    });
}

/* -----------------------------
   VORTEIL HINZUFÜGEN / ENTFERNEN
----------------------------- */

function toggleAdv(a) {
    const idx = char.adv.indexOf(a);

    if (idx >= 0) {
        char.adv.splice(idx, 1);
    } else {
        char.adv.push(a);
    }

    updateTraitsUI();
}

/* -----------------------------
   NACHTEIL HINZUFÜGEN / ENTFERNEN
----------------------------- */

function toggleDis(d) {
    const idx = char.dis.indexOf(d);

    if (idx >= 0) {
        char.dis.splice(idx, 1);
    } else {
        char.dis.push(d);
    }

    updateTraitsUI();
}

/* -----------------------------
   TRAIT UI + BEDINGUNGEN
----------------------------- */

function updateTraitsUI() {

    // Pflichtregeln:
    const minAdv = 2;
    const minDis = 3;

    const advCount = char.adv.length;
    const disCount = char.dis.length;

    // Bedingung: Nachteile müssen Vorteile um +1 übersteigen
    const validRelation = disCount >= advCount + 1;

    // Rote Regelanzeige aktualisieren
    const ruleBox = document.querySelector(".rule-hint-red");

    if (advCount >= minAdv && disCount >= minDis && validRelation) {
        ruleBox.style.color = "var(--gold)";
    } else {
        ruleBox.style.color = "var(--danger)";
    }

    // Step 2 Button freischalten
    const finishBtn = document.getElementById("btn-finish-check");

    if (advCount >= minAdv && disCount >= minDis && validRelation) {
        finishBtn.disabled = false;
    } else {
        finishBtn.disabled = true;
    }

    // Chronik aktualisieren
    updateChronik();
}

/* -----------------------------
   CHRONIK (SEITE 2)
----------------------------- */

function updateChronik() {
    const block = document.getElementById("chronik-text-block");

    block.innerHTML = `
        <b>${char.name || "Unbenannter Held"}</b><br>
        ${char.titel || ""}<br><br>

        <b>Rasse:</b> ${char.race || "-"}<br>
        <b>Untergruppe:</b> ${char.sub || "-"}<br>
        <b>Profession:</b> ${char.prof || "-"}<br>
        <b>Spezialfähigkeit:</b> ${char.special || "-"}<br><br>

        <b>Vorteile:</b><br>
        ${char.adv.length ? char.adv.join(", ") : "-"}<br><br>

        <b>Nachteile:</b><br>
        ${char.dis.length ? char.dis.join(", ") : "-"}<br>
    `;

    drawChronikRadar();
}

/* -----------------------------
   CHRONIK-RADAR (SEITE 2)
----------------------------- */

function drawChronikRadar() {
    const canvas = document.getElementById("chronikRadar");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const values = attributes.map(a => char.attrs[a] || 0);
    const max = 10;
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const r = 80;

    ctx.strokeStyle = "rgba(212,175,55,0.6)";
    ctx.lineWidth = 2;
    ctx.beginPath();

    values.forEach((v, i) => {
        const angle = (Math.PI * 2 / values.length) * i - Math.PI / 2;
        const dist = (v / max) * r;

        const x = cx + Math.cos(angle) * dist;
        const y = cy + Math.sin(angle) * dist;

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });

    ctx.closePath();
    ctx.stroke();
}
/* ============================================================
   CHRONIK UPDATE (STEP 2)
============================================================ */

function updateChronik() {

  char.adv = Array.from(document.querySelectorAll('#adv-list input:checked')).map(i => i.value);
  char.dis = Array.from(document.querySelectorAll('#dis-list input:checked')).map(i => i.value);

  const btn = document.getElementById('btn-finish-check');
  const isValid = (
    char.adv.length >= 2 &&
    char.dis.length >= 3 &&
    char.dis.length === char.adv.length + 1
  );

  btn.disabled = !isValid;
  btn.style.opacity = btn.disabled ? "0.3" : "1";

  document.getElementById('chronik-text-block').innerHTML = `
    <p><b>${char.name}</b>, ${char.titel}<br>
    Volk: ${char.race} (${char.sub})<br>
    Beruf: ${char.prof}</p>

    <div style="display:grid; grid-template-columns:1fr 1fr; border-top:1px solid #444; padding-top:10px;">
      ${idFields.map(f => `
        <div><span style="color:var(--muted)">${f.l}:</span> ${char.identity[f.id] || "-"}</div>
      `).join('')}
    </div>
  `;

  document.getElementById('chronik-traits-cloud').innerHTML =
    [...char.adv, ...char.dis].map(t => `<span class="trait-tag">${t}</span>`).join('');

  drawRadar("chronikRadar");
}

/* ============================================================
   START
============================================================ */

init();
/* ============================================================
   UNDRA ENGINE v1.0 — BLOCK 3/10
   STEP-NAVIGATION + PORTRAIT + ROLL + SAVE + CHRONIK-FLOW
   ============================================================ */

/* ============================================================
   STEP-NAVIGATION
============================================================ */

function toStep1() {
  document.getElementById('step-2').classList.remove('active');
  document.getElementById('step-1').classList.add('active');
}

function toStep2() {

  /* Name & Titel übernehmen */
  char.name = document.getElementById('in-name').value.trim();
  char.titel = document.getElementById('in-titel').value.trim();

  document.getElementById('header-sub-data').textContent =
    `${char.name} | ${char.titel}`;

  document.getElementById('step-1').classList.remove('active');
  document.getElementById('step-2').classList.add('active');

  updateChronik();
}

function toStep3() {
  document.getElementById('step-2').classList.remove('active');
  document.getElementById('step-3').classList.add('active');

  document.getElementById('timeline').style.display = "flex";

  initPage3();
}

/* ============================================================
   PORTRAIT-UPLOAD
============================================================ */

document.getElementById('upload').onchange = (e) => {

  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = (ev) => {
    const img = document.getElementById('preview');
    img.src = ev.target.result;
    img.style.display = "block";

    document.getElementById('placeholder').style.display = "none";
  };

  reader.readAsDataURL(file);
};

/* ============================================================
   ATTRIBUTE AUSWÜRFELN (POOL = 60)
============================================================ */

document.getElementById('roll-btn').onclick = function () {
  char.pool = 60;
  char.used = 0;

  /* Alle Attribute zurücksetzen */
  attributes.forEach(a => char.attrs[a] = 0);

  this.disabled = true;
  updateUI();
};

/* ============================================================
   SAVE-SYSTEM (LOKAL)
============================================================ */

function saveCharacterLocal() {

  let saves = JSON.parse(localStorage.getItem('rpg_saves') || '[]');

  if (saves.length >= 6) saves.shift();

  /* Deep Copy, damit spätere Änderungen nicht alte Saves überschreiben */
  const saveCopy = JSON.parse(JSON.stringify(char));

  saves.push(saveCopy);

  localStorage.setItem('rpg_saves', JSON.stringify(saves));

  alert("Gespeichert!");
}

/* ============================================================
   STEP 3 — FINAL PAGE INITIALISIERUNG
============================================================ */

function initPage3() {

  /* --- Merkmale / Identität --- */
  const finalInf = document.getElementById('stat-merkmale-final');

  finalInf.innerHTML = `
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
      ${idFields.map(f =>
        `<div><b>${f.l}:</b> ${char.identity[f.id] || "-"}</div>`
      ).join('')}
    </div>

    <div style="margin-top:10px; border-top:1px solid var(--gold); padding-top:5px;">
      ${char.race} | ${char.prof} | ${char.special}
    </div>
  `;

  /* --- Portrait übernehmen --- */
  document.getElementById('final-portrait').src =
    document.getElementById('preview').src || "";

  /* --- Radar aktualisieren --- */
  drawRadar("finalRadar");

  /* --- Skills werden in Block 4 erzeugt --- */

  /* --- Aktive Attribute (Block 4) --- */

  /* --- Berechnungen (Block 4) --- */

  /* --- Timeline (Block 5) --- */
}

/* ============================================================
   CHRONIK (STEP 2)
============================================================ */

function updateChronik() {

  char.adv = Array.from(document.querySelectorAll('#adv-list input:checked'))
    .map(i => i.value);

  char.dis = Array.from(document.querySelectorAll('#dis-list input:checked'))
    .map(i => i.value);

  const btn = document.getElementById('btn-finish-check');

  const isValid =
    char.adv.length >= 2 &&
    char.dis.length >= 3 &&
    char.dis.length === char.adv.length + 1;

  btn.disabled = !isValid;
  btn.style.opacity = btn.disabled ? "0.3" : "1";

  /* --- Chronik-Text --- */
  document.getElementById('chronik-text-block').innerHTML = `
    <p><b>${char.name}</b>, ${char.titel}<br>
    Volk: ${char.race} (${char.sub})<br>
    Beruf: ${char.prof}</p>

    <div style="display:grid; grid-template-columns:1fr 1fr; border-top:1px solid #444; padding-top:10px;">
      ${idFields.map(f =>
        `<div><span style="color:var(--muted)">${f.l}:</span> ${char.identity[f.id] || "-"}</div>`
      ).join('')}
    </div>
  `;

  /* --- Trait-Cloud --- */
  document.getElementById('chronik-traits-cloud').innerHTML =
    [...char.adv, ...char.dis]
      .map(t => `<span class="trait-tag">${t}</span>`)
      .join('');

  /* --- Radar --- */
  drawRadar("chronikRadar");
}

/* ============================================================
   UNDRA ENGINE v1.1 — BLOCK 4/10
   INVENTAR + HANDEL + WÄHRUNGSSYSTEM
   ============================================================ */

/* -----------------------------
   INVENTAR INITIALISIEREN
----------------------------- */

function initInventar() {
    const grid = document.getElementById("inv-grid");
    grid.innerHTML = "";

    for (let i = 0; i < 9; i++) {
        grid.innerHTML += `
            <div class="inv-slot">
                <input type="text" placeholder="Gegenstand" style="width:70%;">
                <input type="number" min="0" placeholder="Wert" style="width:25%;">
            </div>`;
    }
}

/* -----------------------------
   WÄHRUNG AKTUALISIEREN
----------------------------- */

function updateCurrencyDisplay() {
    const g = char.gold || 0;
    const s = char.silber || 0;
    const k = char.kupfer || 0;

    document.getElementById("currency-display").textContent = `${g} G ${s} S ${k} K`;
}

/* -----------------------------
   SP ANZEIGE AKTUALISIEREN
----------------------------- */

function updateSPDisplay() {
    document.getElementById("sp-display").textContent = char.sp;
}

/* -----------------------------
   VERKAUF / HANDEL MODAL
----------------------------- */

function confirmSell() {
    const g = parseInt(document.getElementById("v-gold").value) || 0;
    const s = parseInt(document.getElementById("v-silber").value) || 0;
    const k = parseInt(document.getElementById("v-kupfer").value) || 0;

    // SP-Berechnung: 1G = 100 SP, 1S = 10 SP, 1K = 1 SP
    const spGain = g * 100 + s * 10 + k;

    char.gold += g;
    char.silber += s;
    char.kupfer += k;
    char.sp += spGain;

    updateCurrencyDisplay();
    updateSPDisplay();

    document.getElementById("sell-modal").style.display = "none";
}

/* -----------------------------
   TAG BEENDET / SP ZUWACHS
----------------------------- */

function closeThanks() {
    char.day += 1;
    char.sp += 1000;
    char.dailyPoints += 1;

    updateSPDisplay();
    updateCurrencyDisplay();

    document.getElementById("thanks-modal").style.display = "none";
}

/* -----------------------------
   TAG BEENDEN BUTTON
----------------------------- */

function endDay() {
    document.getElementById("thanks-text").textContent =
        `Tag ${char.day} abgeschlossen. Du erhältst 1000 SP und 1 Attributpunkt.`;

    document.getElementById("thanks-modal").style.display = "flex";
}
/* ============================================================
   SKILL-BLOCKS (STEP 3)
============================================================ */

function renderSkillBlock(id, list, type, cost) {

  const cont = document.getElementById(id);
  cont.innerHTML = "";

  list.forEach((s, i) => {

    if (!char.skills[type][i]) char.skills[type][i] = 0;

    cont.innerHTML += `
      <div class="skill-item">
        <span>${s}</span>
        <div style="display:flex; gap:5px; align-items:center;">
          <span id="lv-${type}-${i}">${char.skills[type][i]}</span>
          <button class="btn-upgrade ${char.sp >= cost ? 'glow' : ''}"
            onclick="buySkill('${type}', ${i}, ${cost})">▲</button>
        </div>
      </div>`;
  });
}

function buySkill(type, i, cost) {

  if (char.sp >= cost && char.skills[type][i] < 10) {

    char.sp -= cost;
    char.skills[type][i]++;

    document.getElementById(`lv-${type}-${i}`).textContent =
      char.skills[type][i];

    document.getElementById('sp-display').textContent = char.sp;
  }
}

/* ============================================================
   ACTIVE ATTRIBUTES (STEP 3)
============================================================ */

function renderActiveAttributes() {

  const actGrid = document.getElementById('active-attr-grid');
  actGrid.innerHTML = "";

  attributes.forEach((a, i) => {

    actGrid.innerHTML += `
      <div class="attr-row">
        <span>${a}</span>
        <div class="val-box" id="stat3-v-${i}">${char.attrs[a]}</div>
        <button class="btn-upgrade ${char.dailyPoints > 0 ? 'glow' : ''}"
          onclick="upgradeStat3(${i})">▲</button>
      </div>`;
  });
}

function upgradeStat3(i) {

  const attr = attributes[i];

  if (char.dailyPoints > 0 && char.attrs[attr] < 20) {

    char.attrs[attr]++;
    char.dailyPoints--;

    initPage3(); // Re-render Step 3
  }
}

/* ============================================================
   STAT-BERECHNUNGEN
============================================================ */

function updateStatsCalc() {

  document.getElementById('calc-le').querySelector('span').textContent =
    char.attrs["Konstitution"] * 10 + 30;

  document.getElementById('calc-en').querySelector('span').textContent =
    char.attrs["Mut"] * 5;

  document.getElementById('calc-gg').querySelector('span').textContent =
    char.attrs["Geistiger Zustand"] * 5;

  document.getElementById('calc-tc').querySelector('span').textContent =
    char.attrs["Trefferchance"] * 4 + "%";

  /* Rüstung — Platzhalter */
  document.getElementById('calc-rs').querySelector('span').textContent = 0;
}

/* ============================================================
   INVENTAR (STEP 3)
============================================================ */

function initInventar() {

  const grid = document.getElementById('inv-grid');
  grid.innerHTML = "";

  for (let i = 0; i < 30; i++) {
    grid.innerHTML += `
      <div class="inv-slot">
        Slot ${i + 1}
        <button class="btn-upgrade" onclick="openSell(${i})">$</button>
      </div>`;
  }
}

let currentSlot = 0;

function openSell(i) {
  currentSlot = i;
  document.getElementById('sell-modal').style.display = 'flex';
}

function confirmSell() {

  char.gold += parseInt(document.getElementById('v-gold').value) || 0;
  char.silber += parseInt(document.getElementById('v-silber').value) || 0;
  char.kupfer += parseInt(document.getElementById('v-kupfer').value) || 0;

  document.getElementById('currency-display').textContent =
    `${char.gold} G ${char.silber} S ${char.kupfer} K`;

  document.getElementById('sell-modal').style.display = 'none';
}

/* ============================================================
   DAY-END / TIMELINE
============================================================ */

document.getElementById('btn-dayend').onclick = () => {

  if (char.dayEnded) return;

  char.dayEnded = true;
  char.dailyPoints = 1;
  char.sp += 1000;

  document.getElementById('thanks-text').textContent =
    `Tag ${char.day} abgeschlossen. Du erhältst 1000 SP und 1 Attributpunkt.`;

  document.getElementById('thanks-modal').style.display = 'flex';

  updateTimeline();
  initPage3();
};

function updateTimeline() {

  const tl = document.getElementById('timeline');
  tl.innerHTML = "";

  for (let i = 1; i <= 30; i++) {

    tl.innerHTML += `
      <div class="day-check">
        Tag ${i}
        <input type="checkbox" ${i <= char.day && char.dayEnded ? 'checked' : ''} disabled>
      </div>`;
  }
}

function closeThanks() {

  document.getElementById('thanks-modal').style.display = 'none';

  if (char.day < 30) {
    char.day++;
    char.dayEnded = false;
  }
}

/* ============================================================
   STEP 3 — FINAL PAGE RENDER
============================================================ */

function initPage3() {

  /* --- Identität --- */
  const finalInf = document.getElementById('stat-merkmale-final');

  finalInf.innerHTML = `
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
      ${idFields.map(f =>
        `<div><b>${f.l}:</b> ${char.identity[f.id] || "-"}</div>`
      ).join('')}
    </div>

    <div style="margin-top:10px; border-top:1px solid var(--gold); padding-top:5px;">
      ${char.race} | ${char.prof} | ${char.special}
    </div>
  `;

  /* --- Portrait --- */
  document.getElementById('final-portrait').src =
    document.getElementById('preview').src || "";

  /* --- Radar --- */
  drawRadar("finalRadar");

  /* --- Skills --- */
  renderSkillBlock(
    'skills-base',
    ["Klettern","Schwimmen","Schleichen","Orientierung","Sinnenschärfe",
     "Heilkunde","Reiten","Singen","Springen","Zechen"],
    'base',
    50
  );

  renderSkillBlock(
    'skills-race',
    [char.race + "-Kunde", "Nachtsicht", "Waldlauf", "Steingespür"],
    'race',
    300
  );

  renderSkillBlock(
    'skills-prof',
    [char.prof + "-Wissen", "Waffenfokus", "Magiesinn"],
    'prof',
    500
  );

  /* --- Aktive Attribute --- */
  renderActiveAttributes();

  /* --- Stat-Berechnungen --- */
  updateStatsCalc();

  /* --- Timeline --- */
  updateTimeline();
}

/* ============================================================
   UNDRA ENGINE v1.1 — BLOCK 5/10
   VITALWERTE + AKTIVE ATTRIBUTE + FINAL-RADAR
   ============================================================ */

/* -----------------------------
   AKTIVE ATTRIBUTE (STEP 3)
----------------------------- */

function initActiveAttributes() {
    const grid = document.getElementById("active-attr-grid");
    grid.innerHTML = "";

    attributes.forEach(a => {
        grid.innerHTML += `
            <div class="attr-row">
                <span style="font-size:12px;">${a}</span>
                <button class="btn-upgrade" onclick="upgradeActiveAttr('${a}')">+</button>
                <div class="val-box" id="active-${a}">0</div>
            </div>
        `;
        char.skills.base[a] = 0;
    });
}

function upgradeActiveAttr(a) {
    if (char.dailyPoints <= 0) return;

    char.skills.base[a] += 1;
    char.dailyPoints -= 1;

    updateActiveAttributesUI();
    updateFinalStats();
}

function updateActiveAttributesUI() {
    attributes.forEach(a => {
        document.getElementById("active-" + a).textContent = char.skills.base[a] || 0;
    });
}

/* -----------------------------
   VITALWERTE BERECHNEN
----------------------------- */

function calcVitalwerte() {
    const KK = char.attrs["Körperkraft"] || 0;
    const KO = char.attrs["Konstitution"] || 0;
    const GE = char.attrs["Gewandtheit"] || 0;
    const AN = char.attrs["Angriff"] || 0;
    const VE = char.attrs["Verteidigung"] || 0;
    const TC = char.attrs["Trefferchance"] || 0;

    return {
        leben: 20 + KO * 2 + KK,
        ausdauer: 10 + KO + GE,
        ruestung: Math.floor((KO + GE) / 3),
        geist: 10 + (char.attrs["Geistiger Zustand"] || 0),
        treffer: 30 + TC + Math.floor(AN / 2)
    };
}

/* -----------------------------
   FINAL-STATS AUF SEITE 3
----------------------------- */

function updateFinalStats() {
    const v = calcVitalwerte();

    document.querySelector("#calc-le span").textContent = v.leben;
    document.querySelector("#calc-en span").textContent = v.ausdauer;
    document.querySelector("#calc-rs span").textContent = v.ruestung;
    document.querySelector("#calc-gg span").textContent = v.geist;
    document.querySelector("#calc-tc span").textContent = v.treffer;
}

/* -----------------------------
   FINAL-RADAR (SEITE 3)
----------------------------- */

function drawFinalRadar() {
    const canvas = document.getElementById("finalRadar");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const values = attributes.map(a => (char.attrs[a] || 0) + (char.skills.base[a] || 0));
    const max = 15; // 10 Basis + 5 aktive Attribute
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const r = 90;

    ctx.strokeStyle = "rgba(212,175,55,0.6)";
    ctx.lineWidth = 2;
    ctx.beginPath();

    values.forEach((v, i) => {
        const angle = (Math.PI * 2 / values.length) * i - Math.PI / 2;
        const dist = (v / max) * r;

        const x = cx + Math.cos(angle) * dist;
        const y = cy + Math.sin(angle) * dist;

        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
    });

    ctx.closePath();
    ctx.stroke();
}

/* -----------------------------
   STEP 3 INITIALISIEREN
----------------------------- */

function initStep3() {
    initActiveAttributes();
    updateActiveAttributesUI();
    updateFinalStats();
    drawFinalRadar();

    // Portrait übertragen
    const finalPortrait = document.getElementById("final-portrait");
    const preview = document.getElementById("preview");
    if (preview && preview.src) {
        finalPortrait.src = preview.src;
    }
}

/* -----------------------------
   STEP-WECHSEL
----------------------------- */

function toStep3() {
    document.getElementById("step-1").classList.remove("active");
    document.getElementById("step-2").classList.remove("active");
    document.getElementById("step-3").classList.add("active");

    initStep3();
}
/* ============================================================
   1. SICHERE GET-ELEMENT-FUNKTION
   Verhindert JS-Abbrüche, wenn ein Element fehlt.
============================================================ */

function $(id) {
  return document.getElementById(id);
}

/* ============================================================
   2. SICHERE UI-AKTUALISIERUNG
   Verhindert Fehler, wenn Elemente noch nicht existieren.
============================================================ */

function safeSet(id, value) {
  const el = $(id);
  if (el) el.textContent = value;
}

function safeHTML(id, html) {
  const el = $(id);
  if (el) el.innerHTML = html;
}

/* ============================================================
   3. RADAR-OPTIMIERUNG
   - Kein Flackern
   - Bessere Linien
   - Saubere Schrift
============================================================ */

function drawRadar(id) {

  const canvas = $(id);
  if (!canvas) return;

  const ctx = canvas.getContext("2d");
  const cx = 110, cy = 110, r = 70;

  ctx.clearRect(0,0,220,220);

  const step = (Math.PI*2)/attributes.length;

  ctx.save();
  ctx.lineWidth = 1.2;
  ctx.strokeStyle = "rgba(212,175,55,0.25)";
  ctx.fillStyle = "#d4af37";
  ctx.font = "9px Georgia";

  /* Linien + Labels */
  attributes.forEach((a, i) => {
    const angle = step*i - Math.PI/2;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx + Math.cos(angle)*r, cy + Math.sin(angle)*r);
    ctx.stroke();

    ctx.fillText(
      attrShort[i],
      cx + Math.cos(angle)*(r+12) - 6,
      cy + Math.sin(angle)*(r+12) + 3
    );
  });

  /* Wertefläche */
  ctx.beginPath();
  ctx.strokeStyle = "#f8e7b0";
  ctx.lineWidth = 2;
  ctx.fillStyle = "rgba(212,175,55,0.35)";

  attributes.forEach((a, i) => {
    const val = (char.attrs[a] / 10) * r;
    const angle = step*i - Math.PI/2;
    const x = cx + Math.cos(angle)*val;
    const y = cy + Math.sin(angle)*val;

    if (i === 0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  });

  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  ctx.restore();
}

/* ============================================================
   4. BUTTON-GLOW-LOGIK VERBESSERT
   - Glow nur, wenn SP oder DailyPoints verfügbar
============================================================ */

function updateGlowStates() {

  /* Skill-Buttons */
  document.querySelectorAll('.btn-upgrade').forEach(btn => {
    const cost = parseInt(btn.getAttribute('data-cost') || "0");
    if (cost && char.sp >= cost) btn.classList.add('glow');
    else btn.classList.remove('glow');
  });

  /* Daily Attribute */
  document.querySelectorAll('#active-attr-grid .btn-upgrade').forEach(btn => {
    if (char.dailyPoints > 0) btn.classList.add('glow');
    else btn.classList.remove('glow');
  });
}

/* ============================================================
   5. PERFORMANCE-FIXES
   - Radar wird nur neu gezeichnet, wenn nötig
   - Step-Wechsel reduziert Reflows
============================================================ */

let lastRadarHash = "";

function radarNeedsUpdate() {
  const hash = JSON.stringify(char.attrs);
  if (hash === lastRadarHash) return false;
  lastRadarHash = hash;
  return true;
}

function updateUI() {

  safeSet('p-left', char.pool - char.used);

  safeSet('s-race', char.race || "-");
  safeSet('s-sub', char.sub || "-");
  safeSet('s-prof', char.prof || "-");
  safeSet('s-spec', char.special || "-");

  attributes.forEach(a => {
    safeSet(`v-${a}`, char.attrs[a]);

    const btn = $(`plus-${a}`);
    if (btn) {
      btn.style.opacity =
        (char.pool - char.used <= 0 || char.attrs[a] >= 10)
        ? "0.2"
        : "1";
    }
  });

  if (radarNeedsUpdate()) {
    drawRadar("radarCanvas");
    drawRadar("chronikRadar");
    drawRadar("finalRadar");
  }

  updateGlowStates();
}

/* ============================================================
   6. FEHLERABFANG FÜR MODALS
============================================================ */

function closeModalSafe(id) {
  const el = $(id);
  if (el) el.style.display = "none";
}

function openModalSafe(id) {
  const el = $(id);
  if (el) el.style.display = "flex";
}

/* ============================================================
   7. SICHERHEIT FÜR SELL-MODAL
============================================================ */

function confirmSell() {

  const g = parseInt($('v-gold')?.value || 0);
  const s = parseInt($('v-silber')?.value || 0);
  const k = parseInt($('v-kupfer')?.value || 0);

  char.gold += g;
  char.silber += s;
  char.kupfer += k;

  safeSet('currency-display', `${char.gold} G ${char.silber} S ${char.kupfer} K`);

  closeModalSafe('sell-modal');
}

/* ============================================================
   8. TIMELINE-FIX
   - Kein Flackern
   - Stabiler Fortschritt
============================================================ */

function updateTimeline() {

  const tl = $('timeline');
  if (!tl) return;

  let html = "";

  for (let i = 1; i <= 30; i++) {
    const checked = (i < char.day) || (i === char.day && char.dayEnded);
    html += `
      <div class="day-check">
        Tag ${i}
        <input type="checkbox" ${checked ? "checked" : ""} disabled>
      </div>`;
  }

  tl.innerHTML = html;
}

/* ============================================================
   9. DAY-END FIX
============================================================ */

$('btn-dayend').onclick = () => {

  if (char.dayEnded) return;

  char.dayEnded = true;
  char.dailyPoints = 1;
  char.sp += 1000;

  safeSet('sp-display', char.sp);

  safeSet('thanks-text',
    `Tag ${char.day} abgeschlossen. Du erhältst 1000 SP und 1 Attributpunkt.`);

  openModalSafe('thanks-modal');

  updateTimeline();
  initPage3();
};

/* ============================================================
   10. THANKS-MODAL FIX
============================================================ */

function closeThanks() {

  closeModalSafe('thanks-modal');

  if (char.day < 30) {
    char.day++;
    char.dayEnded = false;
  }

  updateTimeline();
}/* ============================================================
   UNDRA ENGINE v1.0 — BLOCK 6/10
   RASSEN-BONI + PROFESSION-BONI + SPEZIALFÄHIGKEITEN
   ============================================================ */

/* ============================================================
   1. RASSEN-BONI
   Jede Rasse kann:
   - Startattribute geben
   - Passive Effekte geben
   - Skill-Boni geben
============================================================ */

const raceBonuses = {

  "Mensch": {
    attrs: { "Mut": 1, "Intelligenz": 1 },
    skills: { "Diplomat": 1 },
    passive: ["Anpassungsfähig", "Vielseitig"]
  },

  "Elf": {
    attrs: { "Gewandtheit": 2, "Intuition": 1 },
    skills: { "Waldlauf": 1, "Nachtsicht": 1 },
    passive: ["Magische Affinität", "Scharfe Sinne"]
  },

  "Zwerg": {
    attrs: { "Konstitution": 2, "Körperkraft": 1 },
    skills: { "Steingespür": 1 },
    passive: ["Zähigkeit", "Bergvolk"]
  },

  "Ork": {
    attrs: { "Körperkraft": 2, "Mut": 1 },
    skills: { "Kriegswut": 1 },
    passive: ["Wildheit", "Stammeskraft"]
  }
};

/* ============================================================
   2. PROFESSION-BONI
============================================================ */

const professionBonuses = {

  "Ritter": {
    attrs: { "Angriff": 1, "Verteidigung": 1 },
    skills: { "Waffenfokus": 1 },
    passive: ["Ehrenkodex"]
  },

  "Dieb": {
    attrs: { "Fingerfertigkeit": 2 },
    skills: { "Schleichen": 1 },
    passive: ["Schattenhand"]
  },

  "Händler": {
    attrs: { "Charisma": 2 },
    skills: { "Feilschen": 1 },
    passive: ["Goldnase"]
  },

  "Feuermagier": {
    attrs: { "Intelligenz": 2 },
    skills: { "Magiesinn": 1 },
    passive: ["Flammenherz"]
  },

  "Druide": {
    attrs: { "Intuition": 2 },
    skills: { "Naturkunde": 1 },
    passive: ["Tiervertrautheit"]
  },

  "Wildnisläufer": {
    attrs: { "Gewandtheit": 1, "Intuition": 1 },
    skills: { "Fährtensinn": 1 },
    passive: ["Pfadfinder"]
  },

  "Necromant": {
    attrs: { "Geistiger Zustand": 2 },
    skills: { "Dunkelmagie": 1 },
    passive: ["Seelenblick"]
  },

  "Sänger": {
    attrs: { "Charisma": 2 },
    skills: { "Singen": 1 },
    passive: ["Melodienmagie"]
  },

  "Waffenschmied": {
    attrs: { "Technik": 2 },
    skills: { "Schmieden": 1 },
    passive: ["Handwerkskunst"]
  },

  "Bergmann": {
    attrs: { "Körperkraft": 1, "Konstitution": 1 },
    skills: { "Bergbau": 1 },
    passive: ["Grubenerfahrung"]
  },

  "Krieger": {
    attrs: { "Angriff": 2 },
    skills: { "Kampfreflexe": 1 },
    passive: ["Blutrausch"]
  },

  "Schamane": {
    attrs: { "Intuition": 2 },
    skills: { "Ritualkunde": 1 },
    passive: ["Geisterbindung"]
  }
};

/* ============================================================
   3. SPEZIALFÄHIGKEITEN
============================================================ */

const specialAbilities = {

  "Ritter": ["Ehrenhieb", "Schildwall", "Tapferkeit"],
  "Dieb": ["Schattenlauf", "Fingerfertigkeit+", "Lautlos"],
  "Händler": ["Feilscherkönig", "Goldinstinkt", "Überredung"],
  "Feuermagier": ["Feuerlanze", "Manaschild", "Flammenkreis"],
  "Druide": ["Tierform", "Wurzelgriff", "Natursegen"],
  "Wildnisläufer": ["Spurenlesen+", "Waldgeist", "Schnellschuss"],
  "Necromant": ["Knochenspeer", "Seelenraub", "Dunkelbindung"],
  "Sänger": ["Stimme der Macht", "Bardenmut", "Melodienzauber"],
  "Waffenschmied": ["Klingenfokus", "Stahlseele", "Hammerschlag"],
  "Bergmann": ["Erzspür", "Tunnelblick", "Felsgriff"],
  "Krieger": ["Wutstoß", "Kampfrausch", "Schlachtruf"],
  "Schamane": ["Geisterruf", "Totemtanz", "Ahnenmacht"]
};

/* ============================================================
   4. BONI ANWENDEN
============================================================ */

function applyRaceBonuses() {

  const bonus = raceBonuses[char.race];
  if (!bonus) return;

  /* Attribute */
  Object.keys(bonus.attrs).forEach(a => {
    char.attrs[a] += bonus.attrs[a];
  });

  /* Passive Effekte */
  char.passiveRace = bonus.passive || [];

  /* Skills */
  char.skillBonusRace = bonus.skills || {};
}

function applyProfessionBonuses() {

  const bonus = professionBonuses[char.prof];
  if (!bonus) return;

  /* Attribute */
  Object.keys(bonus.attrs).forEach(a => {
    char.attrs[a] += bonus.attrs[a];
  });

  /* Passive Effekte */
  char.passiveProf = bonus.passive || [];

  /* Skills */
  char.skillBonusProf = bonus.skills || {};
}

/* ============================================================
   5. SPEZIALFÄHIGKEIT ZUWEISEN
============================================================ */

function assignSpecialAbility() {

  const list = specialAbilities[char.prof];

  if (!list) {
    char.special = "Standard";
    return;
  }

  char.special = list[Math.floor(Math.random() * list.length)];
}

/* ============================================================
   6. HOOKS IN SELECT-FUNKTIONEN
============================================================ */

const oldSelectRace = selectRace;
selectRace = function (r) {
  oldSelectRace(r);
  applyRaceBonuses();
  updateUI();
};

const oldSelectProf = selectProf;
selectProf = function (p) {
  oldSelectProf(p);
  applyProfessionBonuses();
  assignSpecialAbility();
  updateUI();
};

/* ============================================================
   7. FINAL-SHEET ERWEITERUNG
============================================================ */

function renderFinalBonuses() {

  const cell = $("stat-merkmale-final");

  const racePassives = char.passiveRace?.join(", ") || "-";
  const profPassives = char.passiveProf?.join(", ") || "-";

  cell.innerHTML += `
    <div style="margin-top:10px; border-top:1px solid #333; padding-top:10px;">
      <b>Rassen-Boni:</b> ${racePassives}<br>
      <b>Profession-Boni:</b> ${profPassives}
    </div>
  `;
}

const oldInitPage3 = initPage3;
initPage3 = function () {
  oldInitPage3();
  renderFinalBonuses();
};/* ============================================================
   UNDRA ENGINE v1.0 — BLOCK 7/10
   TOOLTIP-SYSTEM + HOVER-INFOS + DYNAMISCHE POPUPS
   ============================================================ */

/* ============================================================
   1. TOOLTIP ELEMENT ERZEUGEN
============================================================ */

let tooltipEl = null;

function createTooltip() {
  tooltipEl = document.createElement("div");
  tooltipEl.id = "undra-tooltip";
  tooltipEl.style.position = "fixed";
  tooltipEl.style.zIndex = "9999";
  tooltipEl.style.pointerEvents = "none";
  tooltipEl.style.padding = "8px 12px";
  tooltipEl.style.background = "rgba(0,0,0,0.85)";
  tooltipEl.style.border = "1px solid var(--gold)";
  tooltipEl.style.borderRadius = "6px";
  tooltipEl.style.color = "var(--gold-bright)";
  tooltipEl.style.fontSize = "12px";
  tooltipEl.style.fontFamily = "Georgia";
  tooltipEl.style.maxWidth = "260px";
  tooltipEl.style.display = "none";
  tooltipEl.style.boxShadow = "0 0 10px rgba(212,175,55,0.4)";
  document.body.appendChild(tooltipEl);
}

createTooltip();

/* ============================================================
   2. TOOLTIP ANZEIGEN
============================================================ */

function showTooltip(text, x, y) {
  if (!tooltipEl) return;

  tooltipEl.innerHTML = text;
  tooltipEl.style.left = x + 15 + "px";
  tooltipEl.style.top = y + 15 + "px";
  tooltipEl.style.display = "block";
}

/* ============================================================
   3. TOOLTIP VERSTECKEN
============================================================ */

function hideTooltip() {
  if (tooltipEl) tooltipEl.style.display = "none";
}

/* ============================================================
   4. TOOLTIP-REGISTRIERUNG
============================================================ */

function registerTooltip(el, text) {
  el.addEventListener("mousemove", (e) => showTooltip(text, e.clientX, e.clientY));
  el.addEventListener("mouseleave", hideTooltip);
}

/* ============================================================
   5. TOOLTIP-DATENBANK
   (Kann später erweitert werden)
============================================================ */

const tooltipData = {

  /* Attribute */
  "Mut": "Mut beeinflusst Ausdauer, Kampfgeist und Willenskraft.",
  "Intelligenz": "Intelligenz verbessert Magie, Analyse und Problemlösung.",
  "Fingerfertigkeit": "Fingerfertigkeit erhöht Geschick, Schlösserknacken und Diebeskunst.",
  "Gewandtheit": "Gewandtheit verbessert Ausweichen, Bewegung und Reflexe.",
  "Körperkraft": "Körperkraft erhöht Schaden, Traglast und Nahkampfstärke.",
  "Körperbewusstsein": "Verbessert Balance, Körperkontrolle und Akrobatik.",
  "Konstitution": "Erhöht Lebenspunkte und Widerstandskraft.",
  "Charisma": "Verbessert soziale Interaktionen und Handelsgeschick.",
  "Sozialstatus": "Beeinflusst Ansehen, Privilegien und gesellschaftliche Macht.",
  "Geistiger Zustand": "Beeinflusst mentale Stabilität und magische Resistenz.",
  "Intuition": "Verbessert Wahrnehmung, Instinkt und Reaktionsfähigkeit.",
  "Angriff": "Erhöht Trefferchance und Schaden im Nahkampf.",
  "Verteidigung": "Verbessert Blocken, Parieren und Schadensreduktion.",
  "Abwehrschlag": "Chance auf sofortigen Gegenangriff.",
  "Fernkampf": "Verbessert Trefferchance und Schaden mit Fernwaffen.",
  "Trefferchance": "Grundwert für alle Angriffe.",
  "Technik": "Verbessert Handwerk, Mechanik und Schmiedekunst.",

  /* Traits */
  "Wachsam": "Du bemerkst Gefahren früher und erhältst Wahrnehmungsboni.",
  "Zäher Hund": "Du hältst mehr aus und regenerierst schneller.",
  "Glückspilz": "Du hast häufiger kritische Erfolge.",
  "Pechvogel": "Du hast häufiger kritische Fehlschläge.",

  /* Passive Effekte */
  "Anpassungsfähig": "Menschen passen sich schnell an neue Situationen an.",
  "Magische Affinität": "Elfen spüren Magie intuitiv.",
  "Zähigkeit": "Zwerge sind extrem widerstandsfähig.",
  "Wildheit": "Orks kämpfen mit roher Kraft.",

  /* Skills */
  "Klettern": "Erlaubt das Überwinden von Hindernissen und Felswänden.",
  "Schleichen": "Bewegung ohne Geräusche, ideal für Diebe.",
  "Sinnenschärfe": "Verbessert Wahrnehmung und Entdeckung versteckter Dinge.",
  "Magiesinn": "Erlaubt das Spüren magischer Energien.",
  "Waffenfokus": "Erhöht Schaden und Präzision mit bevorzugten Waffen."
};

/* ============================================================
   6. TOOLTIP-AUTO-BINDING FÜR ATTRIBUTE
============================================================ */

function bindAttributeTooltips() {

  attributes.forEach(a => {
    const row = document.getElementById(`row-${a}`);
    if (row && tooltipData[a]) {
      registerTooltip(row, `<b>${a}</b><br>${tooltipData[a]}`);
    }
  });
}

/* ============================================================
   7. TOOLTIP-AUTO-BINDING FÜR SKILLS
============================================================ */

function bindSkillTooltips() {

  document.querySelectorAll(".skill-item span:first-child").forEach(el => {
    const name = el.textContent.trim();
    if (tooltipData[name]) {
      registerTooltip(el, `<b>${name}</b><br>${tooltipData[name]}`);
    }
  });
}

/* ============================================================
   8. TOOLTIP-AUTO-BINDING FÜR TRAITS
============================================================ */

function bindTraitTooltips() {

  document.querySelectorAll("#adv-list label, #dis-list label").forEach(el => {
    const name = el.textContent.trim();
    if (tooltipData[name]) {
      registerTooltip(el, `<b>${name}</b><br>${tooltipData[name]}`);
    }
  });
}

/* ============================================================
   9. TOOLTIP-AUTO-BINDING FÜR PASSIVE BONI
============================================================ */

function bindPassiveTooltips() {

  const racePassives = char.passiveRace || [];
  const profPassives = char.passiveProf || [];

  [...racePassives, ...profPassives].forEach(p => {
    const el = document.querySelector(`.trait-tag:contains('${p}')`);
    if (el && tooltipData[p]) {
      registerTooltip(el, `<b>${p}</b><br>${tooltipData[p]}`);
    }
  });
}

/* ============================================================
   10. HOOK IN INITPAGE3
============================================================ */

const oldInitPage3_Tooltip = initPage3;
initPage3 = function () {
  oldInitPage3_Tooltip();

  bindSkillTooltips();
  bindAttributeTooltips();
  bindTraitTooltips();
  bindPassiveTooltips();
};/* ============================================================
   UNDRA ENGINE v1.0 — BLOCK 8/10
   SOUND-SYSTEM (UI-SOUNDS, HOVER, AMBIENT)
   ============================================================ */

/* ============================================================
   1. SOUND-MANAGER
============================================================ */

const Sound = {
  enabled: true,
  volume: 0.4,

  sounds: {},

  load(name, src) {
    const audio = new Audio(src);
    audio.volume = this.volume;
    this.sounds[name] = audio;
  },

  play(name) {
    if (!this.enabled) return;
    const s = this.sounds[name];
    if (!s) return;
    s.currentTime = 0;
    s.play().catch(() => {});
  },

  setVolume(v) {
    this.volume = v;
    Object.values(this.sounds).forEach(a => a.volume = v);
  }
};

/* ============================================================
   2. SOUND-DATEIEN LADEN
   (Du kannst die Dateien später ersetzen)
============================================================ */

Sound.load("hover",      "https://cdn.jsdelivr.net/gh/naptha/tiny-sfx/click1.mp3");
Sound.load("click",      "https://cdn.jsdelivr.net/gh/naptha/tiny-sfx/click2.mp3");
Sound.load("upgrade",    "https://cdn.jsdelivr.net/gh/naptha/tiny-sfx/powerup.mp3");
Sound.load("buy",        "https://cdn.jsdelivr.net/gh/naptha/tiny-sfx/coin.mp3");
Sound.load("dayend",     "https://cdn.jsdelivr.net/gh/naptha/tiny-sfx/magic.mp3");
Sound.load("ambient",    "https://cdn.jsdelivr.net/gh/naptha/tiny-sfx/wind.mp3");

/* ============================================================
   3. AMBIENT-LOOP
============================================================ */

function startAmbient() {
  const amb = Sound.sounds["ambient"];
  if (!amb) return;

  amb.loop = true;
  amb.volume = 0.15;
  amb.play().catch(() => {});
}

/* ============================================================
   4. UI-SOUNDS AUTOMATISCH BINDEN
============================================================ */

function bindUISounds() {

  /* Buttons */
  document.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("mouseenter", () => Sound.play("hover"));
    btn.addEventListener("click", () => Sound.play("click"));
  });

  /* Skill-Upgrades */
  document.querySelectorAll(".btn-upgrade").forEach(btn => {
    btn.addEventListener("click", () => Sound.play("upgrade"));
  });

  /* Attribute-Upgrades */
  document.querySelectorAll(".btn-step, .btn-plus").forEach(btn => {
    btn.addEventListener("click", () => Sound.play("upgrade"));
  });
}

/* ============================================================
   5. HOOK IN INITPAGE3 (SKILL-KAUF-SOUND)
============================================================ */

const oldBuySkill = buySkill;
buySkill = function (type, i, cost) {
  const before = char.sp;
  oldBuySkill(type, i, cost);
  if (char.sp < before) Sound.play("buy");
};

/* ============================================================
   6. HOOK IN DAY-END
============================================================ */

const oldDayEnd = $('btn-dayend').onclick;
$('btn-dayend').onclick = () => {
  Sound.play("dayend");
  oldDayEnd();
};

/* ============================================================
   7. HOOK IN INITPAGE3 (NEU BINDEN)
============================================================ */

const oldInitPage3_Sound = initPage3;
initPage3 = function () {
  oldInitPage3_Sound();
  bindUISounds();
};

/* ============================================================
   8. SOUND BEIM START AKTIVIEREN
============================================================ */

window.addEventListener("click", () => {
  startAmbient();
}, { once: true });
/* ============================================================
   UNDRA ENGINE v1.0 — BLOCK 9/10
   DEBUG-OVERLAY + DEV-KONSOLE + EXPORT + ERROR-CATCHER
   ============================================================ */

/* ============================================================
   1. DEBUG-OVERLAY ERZEUGEN
============================================================ */

let debugVisible = false;

const debugOverlay = document.createElement("div");
debugOverlay.id = "debug-overlay";
debugOverlay.style.position = "fixed";
debugOverlay.style.bottom = "0";
debugOverlay.style.right = "0";
debugOverlay.style.width = "420px";
debugOverlay.style.height = "260px";
debugOverlay.style.background = "rgba(0,0,0,0.85)";
debugOverlay.style.border = "2px solid var(--gold)";
debugOverlay.style.borderRadius = "8px 0 0 0";
debugOverlay.style.color = "var(--gold-bright)";
debugOverlay.style.fontFamily = "Consolas, monospace";
debugOverlay.style.fontSize = "12px";
debugOverlay.style.padding = "10px";
debugOverlay.style.display = "none";
debugOverlay.style.zIndex = "99999";
debugOverlay.style.overflowY = "auto";
debugOverlay.style.boxShadow = "0 0 20px rgba(212,175,55,0.4)";
document.body.appendChild(debugOverlay);

/* ============================================================
   2. DEBUG-TOGGLE (STRG + D)
============================================================ */

window.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.key.toLowerCase() === "d") {
    debugVisible = !debugVisible;
    debugOverlay.style.display = debugVisible ? "block" : "none";
  }
});

/* ============================================================
   3. DEBUG-LOG-FUNKTION
============================================================ */

function debugLog(msg) {
  const time = new Date().toLocaleTimeString();
  debugOverlay.innerHTML += `<div>[${time}] ${msg}</div>`;
  debugOverlay.scrollTop = debugOverlay.scrollHeight;
}

/* ============================================================
   4. ERROR-CATCHER
============================================================ */

window.onerror = function (msg, src, line, col, err) {
  debugLog(`❌ ERROR: ${msg} @ ${line}:${col}`);
};

/* ============================================================
   5. DEV-KONSOLE (STRG + K)
============================================================ */

let devConsoleVisible = false;

const devConsole = document.createElement("div");
devConsole.id = "dev-console";
devConsole.style.position = "fixed";
devConsole.style.bottom = "260px";
devConsole.style.right = "0";
devConsole.style.width = "420px";
devConsole.style.height = "200px";
devConsole.style.background = "rgba(0,0,0,0.9)";
devConsole.style.border = "2px solid var(--gold)";
devConsole.style.borderRadius = "8px 0 0 0";
devConsole.style.color = "var(--gold-bright)";
devConsole.style.fontFamily = "Consolas, monospace";
devConsole.style.fontSize = "12px";
devConsole.style.padding = "10px";
devConsole.style.display = "none";
devConsole.style.zIndex = "99999";
devConsole.style.boxShadow = "0 0 20px rgba(212,175,55,0.4)";
document.body.appendChild(devConsole);

devConsole.innerHTML = `
  <b>UNDRA DEV-KONSOLE</b><br>
  <small>STRG + K zum Öffnen/Schließen</small><br><br>

  <button onclick="devSetSP()">SP setzen</button>
  <button onclick="devSetAttr()">Attribut setzen</button>
  <button onclick="devReapplyRace()">Race-Boni</button>
  <button onclick="devReapplyProf()">Prof-Boni</button>
  <button onclick="devNewSpecial()">Neue Spezialfähigkeit</button>
  <button onclick="devSetDay()">Tag setzen</button>
  <button onclick="devReset()">Hard Reset</button>
  <button onclick="devExport()">Export</button>

  <div id="dev-output" style="margin-top:10px; max-height:80px; overflow:auto;"></div>
`;

window.addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.key.toLowerCase() === "k") {
    devConsoleVisible = !devConsoleVisible;
    devConsole.style.display = devConsoleVisible ? "block" : "none";
  }
});

/* ============================================================
   6. DEV-FUNKTIONEN
============================================================ */

function devOut(msg) {
  document.getElementById("dev-output").innerHTML += msg + "<br>";
}

/* SP setzen */
function devSetSP() {
  const v = prompt("Neue SP:");
  if (!v) return;
  char.sp = parseInt(v);
  safeSet("sp-display", char.sp);
  devOut("SP gesetzt.");
}

/* Attribut setzen */
function devSetAttr() {
  const a = prompt("Attributname:");
  if (!attributes.includes(a)) return devOut("Ungültiges Attribut.");
  const v = prompt("Neuer Wert:");
  char.attrs[a] = parseInt(v);
  updateUI();
  devOut(`${a} gesetzt.`);
}

/* Race-Boni neu anwenden */
function devReapplyRace() {
  applyRaceBonuses();
  updateUI();
  devOut("Race-Boni angewendet.");
}

/* Profession-Boni neu anwenden */
function devReapplyProf() {
  applyProfessionBonuses();
  updateUI();
  devOut("Profession-Boni angewendet.");
}

/* Neue Spezialfähigkeit */
function devNewSpecial() {
  assignSpecialAbility();
  updateUI();
  devOut("Neue Spezialfähigkeit zugewiesen.");
}

/* Tag setzen */
function devSetDay() {
  const v = prompt("Tag (1–30):");
  char.day = parseInt(v);
  updateTimeline();
  devOut("Tag gesetzt.");
}

/* Hard Reset */
function devReset() {
  if (!confirm("Wirklich zurücksetzen?")) return;
  location.reload();
}

/* Export */
function devExport() {
  const json = JSON.stringify(char, null, 2);
  devOut("<pre>" + json + "</pre>");
  debugLog("Export durchgeführt.");
}/* ============================================================
   UNDRA ENGINE v1.0 — BLOCK 10/10
   AUTO-SAVE + IMPORT + MOBILE-OPTIMIERUNG + FINAL-POLISH
   ============================================================ */

/* ============================================================
   1. AUTO-SAVE (ALLE 10 SEKUNDEN)
============================================================ */

function autoSave() {
  try {
    localStorage.setItem("undra_autosave", JSON.stringify(char));
    debugLog("Autosave durchgeführt.");
  } catch (e) {
    debugLog("Autosave-Fehler: " + e.message);
  }
}

setInterval(autoSave, 10000);

/* ============================================================
   2. AUTO-LOAD BEIM START
============================================================ */

function autoLoad() {
  const data = localStorage.getItem("undra_autosave");
  if (!data) return;

  try {
    const loaded = JSON.parse(data);
    Object.assign(char, loaded);
    debugLog("Autosave geladen.");
  } catch (e) {
    debugLog("Fehler beim Laden des Autosaves.");
  }
}

autoLoad();

/* ============================================================
   3. IMPORT-SYSTEM (JSON → CHAR)
============================================================ */

function importCharacter() {
  const json = prompt("Füge hier den JSON-Charakter ein:");
  if (!json) return;

  try {
    const obj = JSON.parse(json);
    Object.assign(char, obj);
    updateUI();
    initPage3();
    debugLog("Import erfolgreich.");
  } catch (e) {
    alert("Fehler: Ungültiges JSON.");
  }
}

/* DEV-KONSOLE BUTTON */
const oldDevConsole = document.getElementById("dev-console").innerHTML;
document.getElementById("dev-console").innerHTML = oldDevConsole.replace(
  "</button>",
  "</button><button onclick='importCharacter()'>Import</button>"
);

/* ============================================================
   4. MOBILE-OPTIMIERUNG
============================================================ */

/* Größere Touch-Hitboxen */
document.addEventListener("touchstart", () => {}, { passive: true });

function enhanceTouchTargets() {
  document.querySelectorAll("button, .check-item, .btn-upgrade").forEach(el => {
    el.style.minHeight = "32px";
    el.style.padding = "6px 10px";
  });
}

enhanceTouchTargets();

/* Scroll-Fix für iOS */
document.body.style.webkitOverflowScrolling = "touch";

/* ============================================================
   5. PERFORMANCE-BOOST
============================================================ */

/* Radar nur neu zeichnen, wenn sichtbar */
function drawRadarIfVisible(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const rect = el.getBoundingClientRect();
  if (rect.bottom < 0 || rect.top > window.innerHeight) return;
  drawRadar(id);
}

/* Debounce für UI-Updates */
let uiDebounce = false;

function updateUI_Optimized() {
  if (uiDebounce) return;
  uiDebounce = true;
  setTimeout(() => {
    updateUI();
    uiDebounce = false;
  }, 50);
}

/* Hook ersetzen */
const oldUpdateUI = updateUI;
updateUI = updateUI_Optimized;

/* ============================================================
   6. UI-POLISHING (Transitions, sanfte Effekte)
============================================================ */

const style = document.createElement("style");
style.innerHTML = `
  .panel, .attr-row, .skill-item, .inv-slot {
    transition: all 0.25s ease;
  }

  button:hover {
    filter: brightness(1.2);
  }

  #undra-tooltip {
    transition: opacity 0.15s ease;
  }
`;
document.head.appendChild(style);

/* ============================================================
   7. ENGINE-STABILISIERUNG
============================================================ */

function safeNumber(v) {
  return isNaN(v) ? 0 : v;
}

function safeAttr(a) {
  return safeNumber(char.attrs[a] || 0);
}

/* ============================================================
   8. FINAL-LOG
============================================================ */

debugLog("UNDRA ENGINE v1.0 vollständig geladen.");
</script>
</body>
</html>
